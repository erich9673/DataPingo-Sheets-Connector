<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataPingo Admin - Approval Dashboard</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W5VY62S4LR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-W5VY62S4LR', {
            page_title: 'Admin Dashboard',
            custom_map: {
                'custom_user_type': 'admin'
            }
        });
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .request-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: #f9f9f9;
        }
        .request-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .email {
            font-weight: bold;
            color: #4285f4;
            font-size: 1.1em;
        }
        .timestamp {
            color: #666;
            font-size: 0.9em;
        }
        .buttons {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .btn-approve {
            background: #28a745;
            color: white;
        }
        .btn-approve:hover {
            background: #218838;
        }
        .btn-deny {
            background: #dc3545;
            color: white;
        }
        .btn-deny:hover {
            background: #c82333;
        }
        .btn-refresh {
            background: #17a2b8;
            color: white;
            margin-bottom: 20px;
        }
        .btn-refresh:hover {
            background: #138496;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .no-requests {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #495057;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        /* Monitoring Jobs Styles */
        .job-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            transition: box-shadow 0.2s;
        }
        .job-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .job-title {
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
        }
        .job-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .job-status.active {
            background: #d4edda;
            color: #155724;
        }
        .job-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .job-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .job-detail {
            font-size: 0.9em;
        }
        .job-detail-label {
            font-weight: bold;
            color: #6c757d;
        }
        .job-detail-value {
            color: #495057;
        }
        .job-conditions {
            margin-top: 10px;
            padding: 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .no-jobs {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        /* All Users Styles */
        .user-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fff;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .user-email {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }
        .user-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .user-type.active-session {
            background: #d4edda;
            color: #155724;
        }
        .user-type.monitoring-user {
            background: #d1ecf1;
            color: #0c5460;
        }
        .user-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .user-detail {
            font-size: 0.9em;
        }
        .user-detail-label {
            font-weight: bold;
            color: #6c757d;
        }
        .user-detail-value {
            color: #495057;
        }
        .user-jobs-info {
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .no-users {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è DataPingo Admin Dashboard</h1>
            <p>Manage user access requests for Google Sheets Connector</p>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-number" id="pendingCount">-</div>                    <div class="stat-label">Active Sessions</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="totalRequests">-</div>
                    <div class="stat-label">Total Users</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="autoApprovalStatus">üîÑ</div>
                <div class="stat-label">Auto-Approval</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="totalJobs">-</div>
                <div class="stat-label">Monitoring Jobs</div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button class="btn btn-refresh" onclick="loadRequests()">üîÑ Refresh Requests</button>
            <button class="btn" id="autoApprovalToggle" onclick="toggleAutoApproval()" style="background: #6c757d; color: white; margin-left: 10px;">
                ü§ñ Toggle Auto-Approval
            </button>
            <button class="btn" onclick="captureEmails()" style="background: #ff6b35; color: white; margin-left: 10px;">
                üìß Capture Emails
            </button>
            <button class="btn" onclick="exportAdminData('json')" style="background: #007bff; color: white; margin-left: 10px;">
                üìã Export JSON
            </button>
            <button class="btn" onclick="exportAdminData('csv')" style="background: #28a745; color: white; margin-left: 10px;">
                üìä Export CSV
            </button>
        </div>

        <!-- Monitoring Jobs Section -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                üìã Current Monitoring Jobs
            </h3>
            <div id="monitoringJobsList">
                <p style="text-align: center; color: #666; font-style: italic;">Loading monitoring jobs...</p>
            </div>
        </div>

        <!-- All Users Section -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px; margin-bottom: 20px;">
                üë• All Users (Active + Inactive)
            </h3>
            <div style="margin-bottom: 15px; padding: 10px; background: #e9ecef; border-radius: 6px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #28a745;" id="totalUsersCount">-</div>
                        <div style="font-size: 0.9em; color: #666;">Total Users</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #007bff;" id="activeUsersCount">-</div>
                        <div style="font-size: 0.9em; color: #666;">Active Sessions</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #6f42c1;" id="usersWithJobsCount">-</div>
                        <div style="font-size: 0.9em; color: #666;">With Monitoring Jobs</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #fd7e14;" id="totalJobsCount">-</div>
                        <div style="font-size: 0.9em; color: #666;">Total Jobs Created</div>
                    </div>
                </div>
            </div>
            <div id="allUsersList">
                <p style="text-align: center; color: #666; font-style: italic;">Loading all users...</p>
            </div>
        </div>

        <div id="statusMessage"></div>
        <div id="requestsList"></div>
    </div>

    <script>
        // Dynamic API base URL - works for both localhost and Railway
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001/api'
            : '/api';  // Railway production uses same domain

        // Simple analytics tracking for admin actions
        function trackAdminAction(action, details = {}) {
            if (typeof gtag === 'function') {
                gtag('event', 'admin_action', {
                    event_category: 'admin_dashboard',
                    event_label: action,
                    custom_parameters: {
                        action_type: action,
                        timestamp: new Date().toISOString(),
                        ...details
                    }
                });
                console.log('üìä Admin action tracked:', action, details);
            }
        }

        // Track admin dashboard usage
        function trackAdminUsage() {
            trackAdminAction('dashboard_view');
        }

        // Export admin data
        function exportAdminData(format = 'json') {
            // Track the export intention
            trackAdminAction('export_initiated', { format });
            
            // Get current data
            fetch(`${API_BASE}/auth/user-activity`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const exportData = {
                            exportedAt: new Date().toISOString(),
                            userSessions: data.sessions,
                            authTokens: data.tokens,
                            totalUsers: data.totalUsers,
                            activeTokens: data.activeTokens
                        };

                        // Create download
                        const filename = `user_activity_export_${new Date().toISOString().slice(0, 10)}.${format}`;
                        let fileContent;
                        let fileSize;
                        
                        if (format === 'csv') {
                            // Convert to CSV
                            fileContent = convertUserActivityToCSV(data.sessions);
                            fileSize = fileContent.length;
                            downloadFile(fileContent, filename, 'text/csv');
                        } else {
                            // JSON export
                            fileContent = JSON.stringify(exportData, null, 2);
                            fileSize = fileContent.length;
                            downloadFile(fileContent, filename, 'application/json');
                        }

                        // Track successful export with download details
                        trackAdminAction('data_export', { 
                            format, 
                            recordCount: data.totalUsers,
                            filename: filename,
                            fileSize: fileSize
                        });
                        
                        // Track as GA4 download event
                        if (typeof gtag === 'function') {
                            gtag('event', 'file_download', {
                                event_category: 'admin_downloads',
                                event_label: format,
                                value: data.totalUsers,
                                custom_parameters: {
                                    file_name: filename,
                                    file_type: format,
                                    download_source: 'admin_export',
                                    record_count: data.totalUsers
                                }
                            });
                        }
                        
                        showStatus(`‚úÖ User activity exported: ${filename}`, 'success');
                    }
                })
                .catch(error => {
                    console.error('Export failed:', error);
                    trackAdminAction('export_failed', { format, error: error.message });
                    showStatus(`‚ùå Export failed: ${error.message}`, 'error');
                });
        }

        // Helper function to convert user activity to CSV
        function convertUserActivityToCSV(sessions) {
            if (!sessions || sessions.length === 0) return 'No user activity data available';
            
            const headers = ['Gmail Account', 'Token ID', 'Login Time', 'Last Active', 'Is Authenticated', 'Has Google Access'];
            const csvRows = [headers.join(',')];
            
            sessions.forEach(session => {
                const row = [
                    `"${session.email || 'No email captured'}"`,
                    `"${session.tokenId || 'N/A'}"`,
                    `"${session.loginTime || 'N/A'}"`,
                    `"${session.lastActive || 'N/A'}"`,
                    `"${session.authenticated ? 'Yes' : 'No'}"`,
                    `"${session.hasRefreshToken ? 'Yes' : 'No'}"`
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }

        // Helper function to convert requests to CSV (keep for backward compatibility)
        function convertToCSV(requests) {
            if (!requests || requests.length === 0) return 'No data available';
            
            const headers = ['Email', 'Requested At', 'Time Ago'];
            const csvRows = [headers.join(',')];
            
            requests.forEach(request => {
                const row = [
                    `"${request.email}"`,
                    `"${new Date(request.requestedAt || Date.now()).toISOString()}"`,
                    `"${request.timeAgo}"`
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }

        // Helper function to trigger download
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function loadRequests() {
            try {
                // Try new user activity endpoint first
                let response = await fetch(`${API_BASE}/auth/user-activity`);
                
                // If new endpoint fails, fall back to old pending requests endpoint
                if (!response.ok) {
                    console.log('New endpoint not available, falling back to pending requests');
                    response = await fetch(`${API_BASE}/auth/pending-requests`);
                    const data = await response.json();
                    
                    if (data.success) {
                        displayRequests(data.requests);
                        document.getElementById('pendingCount').textContent = data.count;
                        document.getElementById('totalRequests').textContent = data.count;
                    } else {
                        showStatus('Failed to load requests: ' + data.error, 'error');
                    }
                } else {
                    // Use new user activity endpoint
                    const data = await response.json();
                    
                    if (data.success) {
                        displayUserActivity(data.sessions);
                        document.getElementById('pendingCount').textContent = data.activeTokens;
                        document.getElementById('totalRequests').textContent = data.totalUsers;
                    } else {
                        showStatus('Failed to load user activity: ' + data.error, 'error');
                    }
                }
            } catch (error) {
                console.error('Load requests error:', error);
                showStatus('Network error: ' + error.message, 'error');
            }
            
            // Also load auto-approval status and monitoring jobs
            loadAutoApprovalStatus();
            loadMonitoringJobs();
            loadAllUsers();
        }

        async function loadMonitoringJobs() {
            try {
                const response = await fetch(`${API_BASE}/admin/monitoring-jobs`);
                const data = await response.json();
                
                if (data.success) {
                    displayMonitoringJobs(data.jobs);
                    document.getElementById('totalJobs').textContent = data.totalJobs;
                } else {
                    showStatus('Failed to load monitoring jobs: ' + data.error, 'error');
                    document.getElementById('monitoringJobsList').innerHTML = 
                        '<div class="no-jobs">‚ùå Failed to load monitoring jobs</div>';
                }
            } catch (error) {
                console.error('Load monitoring jobs error:', error);
                document.getElementById('monitoringJobsList').innerHTML = 
                    '<div class="no-jobs">‚ö†Ô∏è Network error loading monitoring jobs</div>';
            }
        }

        function displayMonitoringJobs(jobs) {
            const container = document.getElementById('monitoringJobsList');
            if (!jobs || jobs.length === 0) {
                container.innerHTML = '<div class="no-jobs">üì≠ No monitoring jobs currently active</div>';
                return;
            }
            const jobsHtml = jobs.map(job => `
                <div class="job-card">
                    <div class="job-header">
                        <div class="job-title">üìä ${job.spreadsheetName}</div>
                        <div class="job-status ${job.isActive ? 'active' : 'inactive'}">
                            ${job.isActive ? 'üü¢ Active' : 'üî¥ Inactive'}
                        </div>
                    </div>
                    <div class="job-details">
                        <div class="job-detail">
                            <span class="job-detail-label">Range:</span>
                            <span class="job-detail-value">${job.cellRange}</span>
                        </div>
                        <div class="job-detail">
                            <span class="job-detail-label">Frequency:</span>
                            <span class="job-detail-value">${job.frequencyMinutes} min</span>
                        </div>
                        <div class="job-detail">
                            <span class="job-detail-label">User:</span>
                            <span class="job-detail-value">${job.userEmail}</span>
                        </div>
                        <div class="job-detail">
                            <span class="job-detail-label">Source:</span>
                            <span class="job-detail-value">${job.sourceType === 'google_sheets' ? 'üìä Google Sheets' : 'üìÑ Uploaded File'}</span>
                        </div>
                        <div class="job-detail">
                            <span class="job-detail-label">Created:</span>
                            <span class="job-detail-value">${job.createdAgo}</span>
                        </div>
                        <div class="job-detail">
                            <span class="job-detail-label">Last Check:</span>
                            <span class="job-detail-value">${job.lastCheckedAgo}</span>
                        </div>
                    </div>
                    ${job.conditionsCount > 0 ? `
                        <div class="job-conditions">
                            <strong>üìã Conditions (${job.conditionsCount}):</strong> ${job.conditionTypes || 'Various'}
                        </div>
                    ` : ''}
                    <div style="margin-top: 10px; font-size: 0.8em; color: #6c757d;">
                        üîó Webhook: ${job.webhookUrl}
                        ${job.userMention && job.userMention !== 'None' ? ` | üë§ Mentions: ${job.userMention}` : ''}
                    </div>
                    <div class="buttons" style="margin-top: 10px;">
                        <button class="btn btn-deny" onclick="stopMonitoringJob('${job.id}')">üõë Stop Job</button>
                    </div>
                </div>
            `).join('');
            // Add Stop All Jobs button above the list
            container.innerHTML = `
                <div style="text-align:right; margin-bottom:10px;">
                    <button class="btn btn-deny" onclick="stopAllMonitoringJobs()">üõë Stop All Jobs</button>
                </div>
                ${jobsHtml}
            `;
        }

        async function stopMonitoringJob(jobId) {
            try {
                const response = await fetch(`${API_BASE}/admin/monitoring-jobs/stop/${jobId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success) {
                    showStatus('‚úÖ Monitoring job stopped successfully', 'success');
                    loadMonitoringJobs();
                } else {
                    showStatus('‚ùå Failed to stop job: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error stopping job: ' + error.message, 'error');
            }
        }

        async function stopAllMonitoringJobs() {
            if (!confirm('Are you sure you want to stop ALL monitoring jobs?')) return;
            try {
                const response = await fetch(`${API_BASE}/admin/monitoring-jobs/stop-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success) {
                    showStatus('‚úÖ All monitoring jobs stopped', 'success');
                    loadMonitoringJobs();
                } else {
                    showStatus('‚ùå Failed to stop all jobs: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('‚ùå Network error stopping all jobs: ' + error.message, 'error');
            }
        }

        async function loadAutoApprovalStatus() {
            try {
                const response = await fetch(`${API_BASE}/auth/auto-approval-status`);
                const data = await response.json();
                
                if (data.success) {
                    const statusElement = document.getElementById('autoApprovalStatus');
                    const toggleButton = document.getElementById('autoApprovalToggle');
                    
                    if (data.autoApprovalEnabled) {
                        statusElement.textContent = '‚úÖ';
                        toggleButton.style.background = '#28a745';
                        toggleButton.textContent = 'ü§ñ Auto-Approval ON';
                    } else {
                        statusElement.textContent = '‚ùå';
                        toggleButton.style.background = '#dc3545';
                        toggleButton.textContent = 'ü§ñ Auto-Approval OFF';
                    }
                }
            } catch (error) {
                console.error('Failed to load auto-approval status:', error);
            }
        }

        async function toggleAutoApproval() {
            try {
                // Get current status first
                const statusResponse = await fetch(`${API_BASE}/auth/auto-approval-status`);
                const statusData = await statusResponse.json();
                
                if (!statusData.success) {
                    showStatus('Failed to get current status', 'error');
                    return;
                }
                
                // Toggle the status
                const newStatus = !statusData.autoApprovalEnabled;
                
                const response = await fetch(`${API_BASE}/auth/toggle-auto-approval`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: newStatus
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showStatus(`‚úÖ ${data.message}`, 'success');
                    loadAutoApprovalStatus(); // Refresh the status
                } else {
                    showStatus(`‚ùå Failed to toggle auto-approval: ` + data.error, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Network error: ` + error.message, 'error');
            }
        }

        async function loadAllUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/all-users`);
                const data = await response.json();
                
                if (data.success) {
                    displayAllUsers(data.users, data.stats);
                    
                    // Update the stats counters
                    document.getElementById('totalUsersCount').textContent = data.stats.totalUsers;
                    document.getElementById('activeUsersCount').textContent = data.stats.activeSessionUsers;
                    document.getElementById('usersWithJobsCount').textContent = data.stats.usersWithJobs;
                    document.getElementById('totalJobsCount').textContent = data.stats.totalMonitoringJobs;
                } else {
                    showStatus('Failed to load all users: ' + data.error, 'error');
                    document.getElementById('allUsersList').innerHTML = 
                        '<div class="no-users">‚ùå Failed to load users</div>';
                }
            } catch (error) {
                console.error('Load all users error:', error);
                document.getElementById('allUsersList').innerHTML = 
                    '<div class="no-users">‚ö†Ô∏è Network error loading users</div>';
            }
        }

        function displayAllUsers(users, stats) {
            const container = document.getElementById('allUsersList');
            
            if (!users || users.length === 0) {
                container.innerHTML = '<div class="no-users">üë§ No users have tried the product yet</div>';
                return;
            }

            const usersHtml = users.map(user => `
                <div class="user-card">
                    <div class="user-header">
                        <div class="user-email">
                            ${user.type === 'active_session' ? 'üü¢' : 'üë§'} ${user.email}
                        </div>
                        <div class="user-type ${user.type === 'active_session' ? 'active-session' : 'monitoring-user'}">
                            ${user.type === 'active_session' ? 'üî• Active Session' : 'üìä Has Monitoring Jobs'}
                        </div>
                    </div>
                    
                    <div class="user-details">
                        <div class="user-detail">
                            <span class="user-detail-label">Login Time:</span>
                            <span class="user-detail-value">${new Date(user.loginTime).toLocaleString()}</span>
                        </div>
                        <div class="user-detail">
                            <span class="user-detail-label">Last Active:</span>
                            <span class="user-detail-value">${user.lastActive}</span>
                        </div>
                        <div class="user-detail">
                            <span class="user-detail-label">Authentication:</span>
                            <span class="user-detail-value">${user.authenticated ? '‚úÖ Authenticated' : '‚ùå Not Authenticated'}</span>
                        </div>
                        <div class="user-detail">
                            <span class="user-detail-label">Refresh Token:</span>
                            <span class="user-detail-value">${user.hasRefreshToken ? '‚úÖ Has Token' : '‚ùå No Token'}</span>
                        </div>
                    </div>
                    
                    ${user.monitoringJobs > 0 ? `
                        <div class="user-jobs-info">
                            <strong>üìä Monitoring Jobs:</strong> ${user.monitoringJobs} total
                            ${user.activeJobs !== undefined ? ` (${user.activeJobs} active, ${user.inactiveJobs} inactive)` : ''}
                            ${user.isCurrentlyActive ? ' | üü¢ Currently online' : ''}
                        </div>
                    ` : user.type === 'active_session' ? `
                        <div class="user-jobs-info">
                            <strong>üìä Monitoring Jobs:</strong> No monitoring jobs created yet
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 10px; font-size: 0.8em; color: #6c757d;">
                        ${user.tokenId ? `üîë Token: ${user.tokenId}` : ''}
                        ${user.userId ? ` | üÜî User ID: ${user.userId}` : ''}
                        ${user.type === 'monitoring_user' && user.isCurrentlyActive ? ' | ‚ú® Also has active session' : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = usersHtml;
        }

        function displayUserActivity(sessions) {
            const container = document.getElementById('requestsList');
            
            if (sessions.length === 0) {
                container.innerHTML = '<div class="no-requests">üìä No user sessions yet. Users need to login with Google OAuth to appear here.</div>';
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="request-card">
                    <div class="request-info">
                        <div>
                            <div class="email">ÔøΩ Gmail: ${session.email || 'No email captured'}</div>
                            <div class="timestamp">ÔøΩüîë Token: ${session.tokenId}</div>
                            <div class="timestamp">‚è∞ Login: ${session.loginTime}</div>
                            <div class="timestamp">üì± Last Active: ${session.lastActive}</div>
                            <div class="timestamp">üîê Google Access: ${session.hasRefreshToken ? '‚úÖ Yes' : '‚ùå No'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayRequests(requests) {
            const container = document.getElementById('requestsList');
            
            if (requests.length === 0) {
                container.innerHTML = '<div class="no-requests">üéâ No pending requests! All caught up.</div>';
                return;
            }

            container.innerHTML = requests.map(request => `
                <div class="request-card">
                    <div class="request-info">
                        <div>
                            <div class="email">üìß ${request.email}</div>
                            <div class="timestamp">‚è∞ Requested ${request.timeAgo}</div>
                        </div>
                    </div>
                    <div class="buttons">
                        <button class="btn btn-approve" onclick="approveUser('${request.email}')">
                            ‚úÖ Approve
                        </button>
                        <button class="btn btn-deny" onclick="denyUser('${request.email}')">
                            ‚ùå Deny
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function approveUser(email) {
            await handleUserRequest(email, true, 'approved');
        }

        async function denyUser(email) {
            await handleUserRequest(email, false, 'denied');
        }

        async function handleUserRequest(email, approved, action) {
            try {
                const response = await fetch(`${API_BASE}/auth/approve-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        approved: approved
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showStatus(`‚úÖ User ${email} has been ${action}!`, 'success');
                    
                    // Track admin approval action
                    trackAdminAction('user_approval', {
                        action: action,
                        email: email.substring(0, 5) + '***', // Partial email for privacy
                        approved: approved
                    });
                    
                    // Reload requests after 1 second
                    setTimeout(loadRequests, 1000);
                } else {
                    showStatus(`‚ùå Failed to ${action.slice(0, -1)} user: ` + data.error, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Network error: ` + error.message, 'error');
            }
        }

        // Capture emails for active sessions - IMMEDIATE FIX for email export
        async function captureEmails() {
            try {
                showStatus('üîç Attempting to capture Gmail addresses from active sessions...', 'info');
                
                // Get current user activity to find sessions without emails
                const response = await fetch(`${API_BASE}/auth/user-activity`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to get user activity');
                }
                
                const sessionsWithoutEmail = data.sessions.filter(session => 
                    !session.email || session.email === 'No email captured'
                );
                
                if (sessionsWithoutEmail.length === 0) {
                    showStatus('‚úÖ All active sessions already have Gmail addresses captured!', 'success');
                    return;
                }
                
                showStatus(`üìß Found ${sessionsWithoutEmail.length} sessions without emails. Capturing...`, 'info');
                
                // Note: This would require the frontend authToken which we don't have access to from admin page
                // Instead, show instructions to users
                showStatus(
                    `üìß To capture Gmail addresses: Users need to visit the main app and login again with the new OAuth permissions. ` +
                    `Current sessions: ${data.sessions.length}, Missing emails: ${sessionsWithoutEmail.length}`, 
                    'info'
                );
                
                // Track the attempt
                trackAdminAction('email_capture_attempt', { 
                    totalSessions: data.sessions.length,
                    missingSessions: sessionsWithoutEmail.length 
                });
                
            } catch (error) {
                console.error('Email capture failed:', error);
                showStatus(`‚ùå Email capture failed: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }
        }

        // Load requests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadRequests();
            trackAdminUsage(); // Track admin dashboard access
        });

        // Auto-refresh every 30 seconds
        setInterval(loadRequests, 30000);
    </script>
</body>
</html>
